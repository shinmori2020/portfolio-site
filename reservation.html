<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>無料相談予約 - WEB制作サービス</title>

    <!-- FullCalendar CSS -->
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.css' rel='stylesheet' />

    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>

    <!-- EmailJS -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <!-- Google Calendar API -->
    <script src="https://apis.google.com/js/api.js"></script>

    <style>
        /* リセットスタイル */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ベーススタイル */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%);
            color: #ffffff;
            min-height: 100vh;
            line-height: 1.6;
        }

        /* コンテナ */
        .reservation-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        /* ヘッダー */
        .reservation-header {
            text-align: center;
            margin-bottom: 50px;
            animation: fadeInDown 0.8s ease;
        }

        .reservation-header h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #00ff88 0%, #00cc70 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .reservation-header p {
            font-size: 1.2rem;
            color: #aaa;
        }

        /* メインコンテンツグリッド */
        .reservation-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            animation: fadeIn 1s ease;
        }

        /* カレンダーセクション */
        .calendar-section {
            background: #1a1a1a;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }

        .calendar-section h2 {
            color: #00ff88;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        /* FullCalendarカスタムスタイル */
        #calendar {
            background: #0a0a0a;
            padding: 20px;
        }

        .fc {
            background: transparent;
        }

        .fc-theme-standard th,
        .fc-theme-standard td,
        .fc-theme-standard .fc-scrollgrid {
            border-color: #333 !important;
        }

        .fc .fc-button-primary {
            background: rgba(0, 255, 136, 0.1);
            border: 2px solid rgba(0, 255, 136, 0.3);
            color: #00ff88;
            font-weight: 600;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .fc .fc-button-primary:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .fc .fc-button-primary:disabled {
            background: transparent;
            border-color: rgba(255, 255, 255, 0.3);
            color: #666;
            opacity: 0.5;
        }

        .fc .fc-button-primary:focus {
            outline: 2px solid #00ff88;
            outline-offset: 2px;
        }

        .fc-toolbar-title {
            color: #ffffff !important;
            font-size: 1.3rem !important;
        }

        .fc-col-header-cell {
            background: #1a1a1a;
            color: #00ff88 !important;
            font-weight: 600;
        }

        .fc-daygrid-day {
            background: #0a0a0a;
            transition: background 0.3s ease;
        }

        .fc-daygrid-day:hover {
            background: #222;
        }

        .fc-daygrid-day-number {
            color: #ffffff !important;
        }

        .fc-day-today {
            background: rgba(0, 255, 136, 0.1) !important;
        }

        /* 予約可能な日 */
        .available-slot {
            background: rgba(0, 255, 136, 0.2) !important;
            cursor: pointer;
            position: relative;
        }

        .available-slot::after {
            content: '◉';
            color: #00ff88;
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 8px;
        }

        /* 予約済みの日 */
        .booked-slot {
            background: rgba(102, 102, 102, 0.2) !important;
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* フォームセクション */
        .form-section {
            background: #1a1a1a;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            border: 1px solid #333;
        }

        .form-section h2 {
            color: #00ff88;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        /* 時間選択 */
        .time-slots {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 30px;
            padding: 20px;
            background: #0a0a0a;
        }

        .time-slot {
            padding: 10px;
            background: #1a1a1a;
            border: 2px solid #333;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .time-slot:hover {
            border-color: #00ff88;
            transform: translateY(-2px);
        }

        .time-slot.selected {
            background: linear-gradient(135deg, #00ff88 0%, #00cc70 100%);
            color: #0a0a0a;
            border-color: #00ff88;
            font-weight: 600;
        }

        .time-slot.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* フォーム要素 */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #aaa;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 15px;
            background: #0a0a0a;
            border: 2px solid #333;
            color: #ffffff;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.2);
        }

        .form-group input.error,
        .form-group select.error,
        .form-group textarea.error {
            border-color: #ff4444;
        }

        .error-message {
            color: #ff4444;
            font-size: 0.85rem;
            margin-top: 5px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* チェックボックスグループ */
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 15px;
            background: #0a0a0a;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
        }

        .checkbox-item label {
            margin: 0;
            cursor: pointer;
            color: #ffffff;
            text-transform: none;
            letter-spacing: normal;
        }

        /* 送信ボタン */
        .submit-button {
            width: 100%;
            padding: 18px 40px;
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            border: 2px solid rgba(0, 255, 136, 0.3);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            text-transform: uppercase;
            letter-spacing: 2px;
            text-decoration: none;
        }

        .submit-button:hover {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .submit-button:disabled {
            background: transparent;
            border-color: rgba(255, 255, 255, 0.3);
            color: #666;
            cursor: not-allowed;
        }

        .submit-button:focus {
            outline: 2px solid #00ff88;
            outline-offset: 2px;
        }

        /* モーダル */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #1a1a1a;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            position: relative;
            animation: slideUp 0.3s ease;
            border: 2px solid #00ff88;
        }

        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: #aaa;
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: #ffffff;
        }

        .modal h3 {
            color: #00ff88;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .modal p {
            color: #aaa;
            margin-bottom: 15px;
        }

        /* ローディング */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .loading-spinner {
            border: 3px solid #333;
            border-top: 3px solid #00ff88;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        /* アニメーション */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .reservation-main {
                grid-template-columns: 1fr;
            }

            .reservation-header h1 {
                font-size: 2rem;
            }

            .time-slots {
                grid-template-columns: repeat(2, 1fr);
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .reservation-container {
                padding: 20px 15px;
            }

            .calendar-section,
            .form-section {
                padding: 20px;
            }

            .reservation-header h1 {
                font-size: 1.5rem;
            }

            .time-slots {
                grid-template-columns: 1fr;
            }

            /* モバイル用カレンダー最適化 */
            #calendar {
                font-size: 0.85rem;
            }

            .fc-daygrid-day-number {
                font-size: 0.9rem;
                padding: 4px;
            }

            .fc-col-header-cell {
                padding: 8px 0;
                font-size: 0.85rem;
            }

            /* 日付セルの高さを減らす */
            .fc-daygrid-day-frame {
                min-height: 40px;
                height: 40px;
            }

            .fc-daygrid-day {
                height: 40px;
            }

            /* タイトルをコンパクトに */
            .fc-toolbar-title {
                font-size: 1.2rem !important;
            }

            /* ナビゲーションボタンを小さく */
            .fc .fc-button-primary {
                padding: 6px 12px;
                font-size: 0.85rem;
            }
        }

        /* 成功メッセージ */
        .success-message {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 204, 112, 0.2));
            border: 2px solid #00ff88;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .success-message.show {
            display: block;
            animation: slideUp 0.5s ease;
        }

        .success-message h4 {
            color: #00ff88;
            margin-bottom: 10px;
        }

        /* エラーメッセージ */
        .error-banner {
            background: rgba(255, 68, 68, 0.2);
            border: 2px solid #ff4444;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .error-banner.show {
            display: block;
            animation: slideUp 0.5s ease;
        }

        .error-banner h4 {
            color: #ff4444;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="reservation-container">
        <!-- ヘッダー -->
        <div class="reservation-header">
            <h1>無料相談予約</h1>
            <p>WEB制作に関するご相談を無料で承ります。お気軽にご予約ください。</p>
        </div>

        <!-- メインコンテンツ -->
        <div class="reservation-main">
            <!-- カレンダーセクション -->
            <div class="calendar-section">
                <h2>日程を選択</h2>
                <div id="calendar"></div>

                <!-- 選択された日付表示 -->
                <div id="selected-date" style="margin-top: 20px; padding: 15px; background: #0a0a0a; display: none;">
                    <p style="color: #00ff88; font-weight: 600;">選択された日付: <span id="selected-date-text"></span></p>
                </div>
            </div>

            <!-- フォームセクション -->
            <div class="form-section">
                <h2>予約情報を入力</h2>

                <!-- 時間選択 -->
                <div class="form-group" id="time-selection" style="display: none;">
                    <label>時間帯を選択 *</label>
                    <div class="time-slots" id="time-slots">
                        <!-- 動的に時間スロットを生成 -->
                    </div>
                    <span class="error-message" id="time-error">時間を選択してください</span>
                </div>

                <!-- 予約フォーム -->
                <form id="reservation-form">
                    <div class="form-group">
                        <label for="name">お名前 *</label>
                        <input type="text" id="name" name="name" required placeholder="山田 太郎">
                        <span class="error-message" id="name-error">お名前を入力してください</span>
                    </div>

                    <div class="form-group">
                        <label for="email">メールアドレス *</label>
                        <input type="email" id="email" name="email" required placeholder="example@email.com">
                        <span class="error-message" id="email-error">有効なメールアドレスを入力してください</span>
                    </div>

                    <div class="form-group">
                        <label for="phone">電話番号</label>
                        <input type="tel" id="phone" name="phone" placeholder="090-1234-5678">
                        <span class="error-message" id="phone-error">有効な電話番号を入力してください</span>
                    </div>

                    <div class="form-group">
                        <label>相談内容 *</label>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-lp" name="service" value="LP制作">
                                <label for="service-lp">LP制作について</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-web" name="service" value="WEB制作">
                                <label for="service-web">WEB制作について</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-wp" name="service" value="WordPress">
                                <label for="service-wp">WordPress制作について</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-renewal" name="service" value="リニューアル">
                                <label for="service-renewal">既存サイトリニューアル</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-ec" name="service" value="ECサイト">
                                <label for="service-ec">ECサイト構築</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="service-other" name="service" value="その他">
                                <label for="service-other">その他</label>
                            </div>
                        </div>
                        <span class="error-message" id="service-error">少なくとも1つ選択してください</span>
                    </div>

                    <div class="form-group">
                        <label for="budget">予算感</label>
                        <select id="budget" name="budget">
                            <option value="">予算感を選択してください</option>
                            <option value="〜10万円">〜10万円</option>
                            <option value="10-30万円">10-30万円</option>
                            <option value="30-50万円">30-50万円</option>
                            <option value="50-100万円">50-100万円</option>
                            <option value="100万円〜">100万円〜</option>
                            <option value="未定">未定</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="deadline">希望納期</label>
                        <select id="deadline" name="deadline">
                            <option value="">希望納期を選択してください</option>
                            <option value="急ぎ（1ヶ月以内）">急ぎ（1ヶ月以内）</option>
                            <option value="通常（2-3ヶ月）">通常（2-3ヶ月）</option>
                            <option value="余裕あり（3ヶ月以上）">余裕あり（3ヶ月以上）</option>
                            <option value="柔軟に対応">柔軟に対応可能</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="details">詳細なご要望（任意）</label>
                        <textarea id="details" name="details" rows="5" placeholder="具体的なご要望やご質問があればお書きください"></textarea>
                    </div>

                    <!-- ローディング表示 -->
                    <div class="loading" id="loading">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 15px; color: #aaa;">予約を処理中...</p>
                    </div>

                    <!-- 成功メッセージ -->
                    <div class="success-message" id="success-message">
                        <h4>予約が完了しました！</h4>
                        <p>確認メールをお送りしましたのでご確認ください。</p>
                    </div>

                    <!-- エラーメッセージ -->
                    <div class="error-banner" id="error-banner">
                        <h4>エラーが発生しました</h4>
                        <p id="error-text">予約処理中にエラーが発生しました。もう一度お試しください。</p>
                    </div>

                    <button type="submit" class="submit-button" id="submit-button" disabled>
                        予約を確定する
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- 確認モーダル -->
    <div class="modal" id="confirmation-modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">&times;</button>
            <h3>予約内容の確認</h3>
            <div id="confirmation-details">
                <!-- 動的に内容を生成 -->
            </div>
            <button class="submit-button" onclick="confirmReservation()" style="margin-top: 20px;">
                この内容で予約する
            </button>
        </div>
    </div>

    <script>
        // グローバル変数
        let calendar;
        let selectedDate = null;
        let selectedTime = null;
        let formData = {};

        // 営業時間設定
        const businessHours = {
            start: 9,
            end: 18,
            timeSlots: [
                '09:00', '10:00', '11:00', '13:00', '14:00', '15:00', '16:00', '17:00'
            ]
        };

        // 休業日設定（例: 土日）
        const holidays = [0, 6]; // 0: 日曜日, 6: 土曜日

        // EmailJS設定（実際の値に置き換えてください）
        const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY'; // 例: 'AbCdEfGhIjKlMnOpQrSt'
        const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID'; // 例: 'service_abc123'
        const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID'; // 例: 'template_xyz789'

        // EmailJS初期化
        emailjs.init(EMAILJS_PUBLIC_KEY);

        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', function() {
            initializeCalendar();
            setupFormValidation();
            setupEventListeners();

            // ウィンドウリサイズ時の対応
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(function() {
                    const isMobile = window.innerWidth <= 480;
                    if (calendar) {
                        calendar.setOption('height', isMobile ? 300 : 'auto');
                        calendar.setOption('aspectRatio', isMobile ? 1.2 : 1.35);
                    }
                }, 250);
            });
        });

        // カレンダー初期化
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            const isMobile = window.innerWidth <= 480;

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ja',
                height: isMobile ? 300 : 'auto',
                aspectRatio: isMobile ? 1.2 : 1.35,
                headerToolbar: {
                    left: 'prev',
                    center: 'title',
                    right: 'next'
                },
                buttonText: {
                    today: '今日'
                },
                dayCellClassNames: function(arg) {
                    const day = arg.date.getDay();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // 過去の日付
                    if (arg.date < today) {
                        return ['booked-slot'];
                    }

                    // 休業日
                    if (holidays.includes(day)) {
                        return ['booked-slot'];
                    }

                    // 予約可能
                    return ['available-slot'];
                },
                dateClick: function(info) {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    // 過去の日付は選択不可
                    if (info.date < today) {
                        showError('過去の日付は選択できません');
                        return;
                    }

                    // 休業日は選択不可
                    if (holidays.includes(info.date.getDay())) {
                        showError('休業日は選択できません');
                        return;
                    }

                    selectDate(info.date);
                }
            });

            calendar.render();
        }

        // 日付選択処理
        function selectDate(date) {
            selectedDate = date;

            // 選択された日付を表示
            const dateText = formatDate(date);
            document.getElementById('selected-date-text').textContent = dateText;
            document.getElementById('selected-date').style.display = 'block';

            // 時間選択を表示
            document.getElementById('time-selection').style.display = 'block';
            generateTimeSlots(date);

            // 送信ボタンのチェック
            checkSubmitButton();
        }

        // 時間スロット生成
        function generateTimeSlots(date) {
            const timeSlotsContainer = document.getElementById('time-slots');
            timeSlotsContainer.innerHTML = '';

            businessHours.timeSlots.forEach(time => {
                const slot = document.createElement('div');
                slot.className = 'time-slot';
                slot.textContent = time;
                slot.dataset.time = time;

                // ダミーの予約済みチェック（実際はGoogle Calendar APIで確認）
                const isBooked = Math.random() < 0.2; // 20%の確率で予約済み

                if (isBooked) {
                    slot.classList.add('disabled');
                    slot.title = '予約済み';
                } else {
                    slot.addEventListener('click', function() {
                        selectTime(this);
                    });
                }

                timeSlotsContainer.appendChild(slot);
            });
        }

        // 時間選択処理
        function selectTime(element) {
            // 既存の選択をクリア
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });

            // 新しい選択
            element.classList.add('selected');
            selectedTime = element.dataset.time;

            // エラーメッセージを非表示
            document.getElementById('time-error').classList.remove('show');

            // 送信ボタンのチェック
            checkSubmitButton();
        }

        // フォームバリデーション設定
        function setupFormValidation() {
            const form = document.getElementById('reservation-form');
            const inputs = form.querySelectorAll('input[required], select[required]');

            inputs.forEach(input => {
                input.addEventListener('blur', function() {
                    validateField(this);
                });

                input.addEventListener('input', function() {
                    if (this.classList.contains('error')) {
                        validateField(this);
                    }
                    checkSubmitButton();
                });
            });
        }

        // フィールドバリデーション
        function validateField(field) {
            const fieldName = field.name || field.id;
            const errorElement = document.getElementById(fieldName + '-error');

            let isValid = true;

            // 必須チェック
            if (field.required && !field.value.trim()) {
                isValid = false;
            }

            // メールアドレスバリデーション
            if (field.type === 'email' && field.value) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(field.value)) {
                    isValid = false;
                }
            }

            // 電話番号バリデーション
            if (field.type === 'tel' && field.value) {
                const phoneRegex = /^[\d-]+$/;
                if (!phoneRegex.test(field.value)) {
                    isValid = false;
                }
            }

            // エラー表示制御
            if (isValid) {
                field.classList.remove('error');
                if (errorElement) {
                    errorElement.classList.remove('show');
                }
            } else {
                field.classList.add('error');
                if (errorElement) {
                    errorElement.classList.add('show');
                }
            }

            return isValid;
        }

        // チェックボックスバリデーション
        function validateCheckboxes() {
            const checkboxes = document.querySelectorAll('input[name="service"]');
            const checked = Array.from(checkboxes).some(cb => cb.checked);
            const errorElement = document.getElementById('service-error');

            if (!checked) {
                errorElement.classList.add('show');
                return false;
            } else {
                errorElement.classList.remove('show');
                return true;
            }
        }

        // 送信ボタンの有効/無効チェック
        function checkSubmitButton() {
            const submitButton = document.getElementById('submit-button');
            const nameValid = document.getElementById('name').value.trim() !== '';
            const emailValid = document.getElementById('email').value.trim() !== '';
            const servicesValid = document.querySelectorAll('input[name="service"]:checked').length > 0;

            if (selectedDate && selectedTime && nameValid && emailValid && servicesValid) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }

        // イベントリスナー設定
        function setupEventListeners() {
            // フォーム送信
            document.getElementById('reservation-form').addEventListener('submit', function(e) {
                e.preventDefault();

                if (validateForm()) {
                    showConfirmationModal();
                }
            });

            // チェックボックス変更監視
            document.querySelectorAll('input[name="service"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    validateCheckboxes();
                    checkSubmitButton();
                });
            });
        }

        // フォーム全体のバリデーション
        function validateForm() {
            let isValid = true;

            // 日付と時間
            if (!selectedDate || !selectedTime) {
                showError('日付と時間を選択してください');
                isValid = false;
            }

            // 必須フィールド
            const requiredFields = ['name', 'email'];
            requiredFields.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (!validateField(field)) {
                    isValid = false;
                }
            });

            // チェックボックス
            if (!validateCheckboxes()) {
                isValid = false;
            }

            return isValid;
        }

        // 確認モーダル表示
        function showConfirmationModal() {
            // フォームデータ収集
            collectFormData();

            // 確認内容生成
            const details = document.getElementById('confirmation-details');
            details.innerHTML = `
                <p><strong>日時:</strong> ${formatDate(selectedDate)} ${selectedTime}</p>
                <p><strong>お名前:</strong> ${formData.name}</p>
                <p><strong>メールアドレス:</strong> ${formData.email}</p>
                <p><strong>電話番号:</strong> ${formData.phone || 'なし'}</p>
                <p><strong>相談内容:</strong> ${formData.services.join(', ')}</p>
                <p><strong>予算感:</strong> ${formData.budget || '未定'}</p>
                <p><strong>希望納期:</strong> ${formData.deadline || '未定'}</p>
                ${formData.details ? `<p><strong>詳細:</strong> ${formData.details}</p>` : ''}
            `;

            // モーダル表示
            document.getElementById('confirmation-modal').classList.add('show');
        }

        // モーダル閉じる
        function closeModal() {
            document.getElementById('confirmation-modal').classList.remove('show');
        }

        // フォームデータ収集
        function collectFormData() {
            formData = {
                date: formatDate(selectedDate),
                time: selectedTime,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                services: Array.from(document.querySelectorAll('input[name="service"]:checked'))
                    .map(cb => cb.value),
                budget: document.getElementById('budget').value,
                deadline: document.getElementById('deadline').value,
                details: document.getElementById('details').value
            };
        }

        // 予約確定処理
        async function confirmReservation() {
            closeModal();

            // ローディング表示
            document.getElementById('loading').classList.add('show');
            document.getElementById('submit-button').disabled = true;

            try {
                // EmailJS でメール送信（お客様向け）
                await sendConfirmationEmail();

                // EmailJS でメール送信（事業者向け）
                await sendNotificationEmail();

                // 成功処理
                showSuccess();

            } catch (error) {
                console.error('Error:', error);
                showError('予約処理中にエラーが発生しました。');
            } finally {
                document.getElementById('loading').classList.remove('show');
            }
        }

        // 確認メール送信（お客様向け）
        async function sendConfirmationEmail() {
            // EmailJSのテンプレートパラメータ
            const templateParams = {
                to_email: formData.email,
                to_name: formData.name,
                date: formData.date,
                time: formData.time,
                services: formData.services.join(', '),
                budget: formData.budget || '未定',
                deadline: formData.deadline || '未定',
                details: formData.details || 'なし'
            };

            // EmailJSでメール送信
            try {
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                console.log('確認メール送信成功:', templateParams);
            } catch (error) {
                console.error('確認メール送信エラー:', error);
                // エラーが発生してもフォーム送信は続行
            }
        }

        // 通知メール送信（事業者向け）
        async function sendNotificationEmail() {
            // EmailJSのテンプレートパラメータ
            const templateParams = {
                from_name: formData.name,
                from_email: formData.email,
                phone: formData.phone || 'なし',
                date: formData.date,
                time: formData.time,
                services: formData.services.join(', '),
                budget: formData.budget || '未定',
                deadline: formData.deadline || '未定',
                details: formData.details || 'なし'
            };

            // EmailJSでメール送信（通知用テンプレートがある場合）
            try {
                // 別のテンプレートIDを使用する場合はここで指定
                // await emailjs.send(EMAILJS_SERVICE_ID, 'YOUR_NOTIFICATION_TEMPLATE_ID', templateParams);
                console.log('通知メール送信（必要に応じて有効化）:', templateParams);
            } catch (error) {
                console.error('通知メール送信エラー:', error);
                // エラーが発生してもフォーム送信は続行
            }
        }

        // 成功表示
        function showSuccess() {
            document.getElementById('success-message').classList.add('show');

            // フォームリセット
            setTimeout(() => {
                resetForm();
            }, 3000);
        }

        // エラー表示
        function showError(message) {
            const errorBanner = document.getElementById('error-banner');
            const errorText = document.getElementById('error-text');

            errorText.textContent = message;
            errorBanner.classList.add('show');

            setTimeout(() => {
                errorBanner.classList.remove('show');
            }, 5000);
        }

        // フォームリセット
        function resetForm() {
            document.getElementById('reservation-form').reset();
            selectedDate = null;
            selectedTime = null;

            // UI リセット
            document.getElementById('selected-date').style.display = 'none';
            document.getElementById('time-selection').style.display = 'none';
            document.getElementById('success-message').classList.remove('show');
            document.getElementById('submit-button').disabled = true;

            // 時間スロットのリセット
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.classList.remove('selected');
            });

            // エラー表示のリセット
            document.querySelectorAll('.error-message').forEach(error => {
                error.classList.remove('show');
            });

            document.querySelectorAll('.error').forEach(field => {
                field.classList.remove('error');
            });
        }

        // 日付フォーマット
        function formatDate(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];

            return `${year}年${month}月${day}日（${weekday}）`;
        }

        // Google Calendar API 関連（実装例）
        // 実際の実装では、Google Calendar APIの認証と連携が必要
        async function checkGoogleCalendarAvailability(date, time) {
            // Google Calendar APIで空き状況を確認
            // この部分は実際のAPI実装が必要
            return true; // デモ用
        }

        async function createGoogleCalendarEvent(data) {
            // Google Calendar APIで予定を作成
            // この部分は実際のAPI実装が必要
            console.log('Creating Google Calendar event:', data);
        }
    </script>
</body>
</html>