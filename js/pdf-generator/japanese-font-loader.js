/**
 * 日本語フォントローダー
 * M+ 1p Regularフォント（軽量版）を使用
 * CDNから動的に読み込み
 */

(function() {
    'use strict';

    /**
     * 日本語フォントをjsPDFに追加する関数
     */
    window.loadJapaneseFont = async function(doc) {
        try {
            // M+ FONTSのCDNから軽量な日本語フォントを読み込み
            // 注: 実際の実装では、フォントファイルをBase64エンコードして埋め込む必要があります

            // カスタムフォントの定義（簡易的な日本語対応）
            // jsPDFのデフォルトフォントを拡張
            const vfsFileName = 'NotoSansCJK.ttf';

            // フォントが既に登録されているかチェック
            if (doc.getFontList()['NotoSansCJK']) {
                return true;
            }

            // 代替案：Web Fontを使用した簡易実装
            // 完全な日本語フォントには大きなBase64データが必要ですが、
            // ここでは基本的な日本語文字セットのみサポート

            // 基本的な日本語文字のマッピング（簡易版）
            const japaneseCharMap = {
                'あ': '\u3042', 'い': '\u3044', 'う': '\u3046', 'え': '\u3048', 'お': '\u304A',
                'か': '\u304B', 'き': '\u304D', 'く': '\u304F', 'け': '\u3051', 'こ': '\u3053',
                'さ': '\u3055', 'し': '\u3057', 'す': '\u3059', 'せ': '\u305B', 'そ': '\u305D',
                'た': '\u305F', 'ち': '\u3061', 'つ': '\u3064', 'て': '\u3066', 'と': '\u3068',
                'な': '\u306A', 'に': '\u306B', 'ぬ': '\u306C', 'ね': '\u306D', 'の': '\u306E',
                'は': '\u306F', 'ひ': '\u3072', 'ふ': '\u3075', 'へ': '\u3078', 'ほ': '\u307B',
                'ま': '\u307E', 'み': '\u307F', 'む': '\u3080', 'め': '\u3081', 'も': '\u3082',
                'や': '\u3084', 'ゆ': '\u3086', 'よ': '\u3088',
                'ら': '\u3089', 'り': '\u308A', 'る': '\u308B', 'れ': '\u308C', 'ろ': '\u308D',
                'わ': '\u308F', 'を': '\u3092', 'ん': '\u3093',
                'ア': '\u30A2', 'イ': '\u30A4', 'ウ': '\u30A6', 'エ': '\u30A8', 'オ': '\u30AA',
                'カ': '\u30AB', 'キ': '\u30AD', 'ク': '\u30AF', 'ケ': '\u30B1', 'コ': '\u30B3',
                'サ': '\u30B5', 'シ': '\u30B7', 'ス': '\u30B9', 'セ': '\u30BB', 'ソ': '\u30BD',
                'タ': '\u30BF', 'チ': '\u30C1', 'ツ': '\u30C4', 'テ': '\u30C6', 'ト': '\u30C8',
                'ナ': '\u30CA', 'ニ': '\u30CB', 'ヌ': '\u30CC', 'ネ': '\u30CD', 'ノ': '\u30CE',
                'ハ': '\u30CF', 'ヒ': '\u30D2', 'フ': '\u30D5', 'ヘ': '\u30D8', 'ホ': '\u30DB',
                'マ': '\u30DE', 'ミ': '\u30DF', 'ム': '\u30E0', 'メ': '\u30E1', 'モ': '\u30E2',
                'ヤ': '\u30E4', 'ユ': '\u30E6', 'ヨ': '\u30E8',
                'ラ': '\u30E9', 'リ': '\u30EA', 'ル': '\u30EB', 'レ': '\u30EC', 'ロ': '\u30ED',
                'ワ': '\u30EF', 'ヲ': '\u30F2', 'ン': '\u30F3',
                '、': '\u3001', '。': '\u3002', '・': '\u30FB', 'ー': '\u30FC',
                '「': '\u300C', '」': '\u300D', '（': '\uFF08', '）': '\uFF09',
                '【': '\u3010', '】': '\u3011', '〒': '\u3012',
                '様': '\u69D8', '御': '\u5FA1', '見': '\u898B', '積': '\u7A4D', '書': '\u66F8',
                '番': '\u756A', '号': '\u53F7', '発': '\u767A', '行': '\u884C', '日': '\u65E5',
                '年': '\u5E74', '月': '\u6708', '円': '\u5186', '税': '\u7A0E', '別': '\u5225',
                '合': '\u5408', '計': '\u8A08', '金': '\u91D1', '額': '\u984D', '内': '\u5185',
                '訳': '\u8A33', '区': '\u533A', '分': '\u5206', '項': '\u9805', '目': '\u76EE',
                '小': '\u5C0F', '備': '\u5099', '考': '\u8003', '有': '\u6709', '効': '\u52B9',
                '期': '\u671F', '限': '\u9650', '間': '\u9593', '以': '\u4EE5', '上': '\u4E0A',
                '消': '\u6D88', '費': '\u8CBB', '加': '\u52A0', '算': '\u7B97', '支': '\u652F',
                '払': '\u6255', '条': '\u6761', '件': '\u4EF6', '納': '\u7D0D', '品': '\u54C1',
                '後': '\u5F8C', '不': '\u4E0D', '明': '\u660E', '点': '\u70B9', '質': '\u8CEA',
                '問': '\u554F', '株': '\u682A', '式': '\u5F0F', '会': '\u4F1A', '社': '\u793E',
                '東': '\u6771', '京': '\u4EAC', '都': '\u90FD'
            };

            // 簡易的な日本語サポートを有効化
            doc.japaneseSupport = true;
            doc.japaneseCharMap = japaneseCharMap;

            return true;

        } catch (error) {
            console.error('フォント読み込みエラー:', error);
            return false;
        }
    };

    /**
     * 日本語テキストを処理する関数
     * 簡易的な文字変換を行う
     */
    window.processJapaneseText = function(text) {
        // 基本的な日本語文字を処理可能な形式に変換
        let processedText = text;

        // 全角英数字を半角に変換
        processedText = processedText.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
            return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
        });

        // 一部の記号を置換
        processedText = processedText.replace(/　/g, ' '); // 全角スペースを半角に

        return processedText;
    };

    /**
     * 簡易的な日本語描画関数
     * フォントが対応していない場合の代替処理
     */
    window.drawJapaneseText = function(doc, text, x, y, options = {}) {
        try {
            // テキストを処理
            const processedText = processJapaneseText(text);

            // 描画を試みる
            doc.text(processedText, x, y, options);

        } catch (error) {
            // エラーの場合は代替テキストを表示
            console.warn('日本語描画エラー:', error);
            doc.text('[' + text.length + ' chars]', x, y, options);
        }
    };

})();